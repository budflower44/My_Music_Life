async function getTokenToServer(){
    try {
        const url = "/mml/token";
        const config = {
            method:'post'
        };
        const resp = await fetch(url, config);
        const result = await resp.text();
        // console.log("getTokenToServer result >> "+result);
        return result;
    } catch (error) {
        console.log(error);
    }
}

async function fetchWebApi(token, keyword) {
    var res1 = encodeURI(keyword);
    console.log(keyword);
    const res = await fetch(`https://api.spotify.com/v1/search?q=${keyword}&type=album%2Ctrack%2Cartist`, {
        headers: {
            Authorization: `Bearer ${token}`,
        },
        method : 'GET'
    });
  const data = await res.json();
  console.log(data);
  return data;
}

async function searchAlbumsDataToServer(searchData){
    try {
        const url = "/mml/search/albums";
        const config = {
            method : 'post',
            headers : {
                'content-type' : 'application/json; charset=utf-8'
            },
            body : JSON.stringify(searchData)
        };
        const resp = await fetch(url, config);
        const result = await resp.text();
        console.log("서버 응답 받음:", result);
    } catch (error) {
        console.log(error);
    }
}

document.getElementById('searchBtn').addEventListener('click', async ()=>{
    try {
        const keywordVal = document.getElementById('searchKeyword').value;
        console.log(keywordVal);
        getTokenToServer().then(token=>{
            fetchWebApi(token, keywordVal).then(res =>{
                if(res.albums){
                    searchAlbumsDataToServer(res.albums);
                    for(let i=0; i<res.albums.items.length; i++){
                        console.log(res.albums.items[i].external_urls.spotify);
                        const url = res.albums.items[i].external_urls.spotify;
                        const embedUrl = url.match(/\/album\/(\w+)/)[0];
                        console.log(embedUrl);
                    }
                }
                if(res.artists){
                    for(let i=0; i<res.artists.items.length; i++){
                        console.log(res.artists.items[i].external_urls.spotify);
                        const url = res.artists.items[i].external_urls.spotify;
                        const embedUrl = url.match(/\/artist\/(\w+)/)[0];
                        console.log(embedUrl);
                    }
                }
                if(res.tracks){
                    for(let i=0; i<res.tracks.items.length; i++){
                        console.log(res.tracks.items[i].external_urls.spotify);
                        const url = res.tracks.items[i].external_urls.spotify;
                        const embedUrl = url.match(/\/track\/(\w+)/)[0];
                        console.log(embedUrl);
                    }
                }

                location.href="/mml/main";

            })
        })
    } catch (error) {
        console.log(error);
    }
})

// async function navigateToPage(url) {
//     try {
//         // Fetch API를 사용하여 비동기로 페이지를 가져옴
//         const response = await fetch(url);

//         if (!response.ok) {
//             throw new Error('Request failed with status ' + response.status);
//         }

//         // 페이지 내용을 텍스트로 변환
//         const html = await response.text();

//         // 현재 페이지의 HTML을 가져와서 페이지를 갱신
//         document.documentElement.innerHTML = html;

//     } catch (error) {
//         console.error('Error:', error);
//     }
// }

// // 페이지 이동 트리거
// var link = document.getElementById('yourLinkId');
// link.addEventListener('click', async function(event) {
//     // 기본 동작을 막아 페이지가 새로고침되지 않도록 함
//     event.preventDefault();

//     // 페이지 이동 함수 호출
//     await navigateToPage(this.href);
// });
